# Домашнее задание 7. Metric Learning для поиска похожих автомобилей



**Задача:** Обучение модели для поиска автомобилей того же класса в базе данных на основе эмбеддингов изображений



## Описание проекта

Проект решает задачу метрического обучения (metric learning) для классификации автомобилей. Вместо прямой классификации модель учится создавать эмбеддинги, в которых автомобили одного класса располагаются близко друг к другу в векторном пространстве.



## Датасет

Датасет cars196 на 196 классов. Классы сбалансированны.



## Ключевые компоненты



### 1. Архитектура модели

- **Базовый эмбеддер:** MobileNetV2 (предобученный на ImageNet)

- **Модификация:** Замена классификационной головы на линейный слой (50-мерный эмбеддинг)

- **Нормализация:** L2-нормализация выходных эмбеддингов



### 2. Метрические функции потерь

- **Center Loss:** Притягивает эмбеддинги к центроидам своих классов

- **Triplet Loss (Euclidean):** Контрастное обучение с hard negative mining

- **Обе функции:** Реализованы с нуля с полной векторизацией



### 3. Аугментации данных

- RandomResizedCrop (0.95-1.0 масштаб)

- RandomHorizontalFlip (p=1.0)

- Multiple RandomErasing (мелкие артефакты)

- RandomRotation (±15 градусов)



## Результаты экспериментов



### Графики обучения:



![Center Loss](https://s2.radikal.cloud/2026/02/07/SNIMOK-EKRANA-2026-02-07-182839f86bd6af76bfab19.png)

![Triplet Loss](https://radika1.link/2026/02/07/SNIMOK-EKRANA-2026-02-07-1828566487e2ab60e0e289.png)



### Качество поиска (на тестовой выборке):

- **Необученная модель:**

&nbsp; - Precision@1: 13.6%, Recall@1: 0.4%

&nbsp; - Precision@5: 7.9%, Recall@5: 1.2%



- **Center Loss (без аугментаций):**

&nbsp; - Precision@1: 33.1%, Recall@1: 1.0%

&nbsp; - Precision@5: 31.8%, Recall@5: 4.8%



- **Center Loss (с аугментациями):**

&nbsp; - Precision@1: 50.1%, Recall@1: 1.5%

&nbsp; - Precision@5: 45.2%, Recall@5: 6.9%



- **Triplet Loss (без аугментаций):**

&nbsp; - Precision@1: 69.4%, Recall@1: 2.1%

&nbsp; - Precision@5: 68.8%, Recall@5: 10.5%



- **Triplet Loss (с аугментациями):**

&nbsp; - **Precision@1: 72.2%, Recall@1: 2.2%**

&nbsp; - **Precision@5: 70.1%, Recall@5: 10.7%**



## Технические особенности



### Реализованные функции:

- `CropClassifDataset` — кастомный датасет с поддержкой аугментаций

- `CenterLoss` и `TripletLossEuclid` — метрические функции потерь

- `GetPrecisionRecallK` — вычисление метрик поиска с использованием FAISS

- Полный пайплайн обучения с валидацией

- Grad-CAM визуализация зон внимания



### Используемые технологии:

- PyTorch, TorchVision

- FAISS (эффективный поиск ближайших соседей)

- Grad-CAM (визуализация внимания модели)

- NumPy, OpenCV



## Ключевые выводы



### 1. Эффективность методов:

- **Triplet Loss значительно превосходит Center Loss** (72.2% vs 50.1% Precision@1)

- **Hard negative mining в Triplet Loss** критически важен для качества

- **Аугментации дают стабильный прирост** для обоих методов



### 2. Особенности обучения:

- **Оптимальная размерность эмбеддинга:** 50 (баланс между выразительностью и стабильностью)

- **Learning rate:** 1e-4 для Center Loss, 3e-4 для Triplet Loss



### 3. Анализ ошибок (Grad-CAM):

- Модель фокусируется на **бамперах, дверях, колесах**

- Проблемные зоны: **тени, неоднородное освещение**

- **Смещенные зоны внимания** указывают на недостаточную уверенность модели



### 4. Пути улучшения:

- Добавление **аугментаций для устранения влияния теней**

- Эксперименты с **разными архитектурами embedder'ов**

- Комбинация **нескольких метрических функций потерь**

- **Контрастная аугментация** для улучшения устойчивости к освещению



Домашнее задание демонстрирует полный цикл решения задачи Metric Learning: от подготовки данных и реализации функций потерь до обучения моделей, оценки качества и визуального анализа результатов.

